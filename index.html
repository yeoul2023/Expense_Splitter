<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Expense_Splitter(휴양지 Edition)</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 기본 리셋 및 폰트 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      color: #333;
      line-height: 1.5;
      padding: 10px;
    }
    :root {
      --input-border: 1px solid rgba(0,0,0,0.2);
      --border-radius: 4px;
      --transition-speed: 0.2s;
    }
    /* select 기본 화살표 제거 */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none;
    }
    /* 전체 레이아웃 */
    #container {
      display: flex;
      height: calc(100vh - 20px);
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    /* 좌측 사이드바 */
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
    }
    #participantContainer {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    #participantSection h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    #participantSection input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    #addParticipantBtn {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background: linear-gradient(45deg, #a8e6cf, #dcedc1);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition-speed);
      margin-bottom: 10px;
    }
    #addParticipantBtn:hover { background: linear-gradient(45deg, #92d8bb, #c5e0aa); }
    #participantList {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #participantList li {
      padding: 10px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    #participantList li .p-name {
      font-weight: 500;
      font-size: 16px;
      margin-bottom: 4px;
    }
    #participantList li .p-totals {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }
    #participantList li button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #d9534f;
    }
    /* 글로벌 컨트롤 영역 */
    #globalControls {
      padding: 10px;
      border-top: 1px solid #e0e0e0;
      background: #fff;
      position: sticky;
      bottom: 0;
      z-index: 1;
    }
    #globalControls button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    #copyReportBtn { background: linear-gradient(45deg, #aedff7, #87cefa); color: #333; }
    #exportDataBtn { background: linear-gradient(45deg, #d1c4e9, #b39ddb); color: #333; }
    #resetDataBtn { background: linear-gradient(45deg, #ffccd2, #ef9a9a); color: #333; }
    #settingsBtn { background: linear-gradient(45deg, #cfd8dc, #b0bec5); color: #333; }
    /* 우측 메인 영역 */
    #main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    /* 정산 항목 추가 영역 */
    #expenseSection {
      background: #fff;
      border: var(--input-border);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #expenseSection h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    /* 정산 사유, 날짜, 시각 입력 – 한 줄에 배치 */
    .expense-inputs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .expense-inputs label {
      font-size: 14px;
      color: #555;
      margin-bottom: 4px;
      display: block;
    }
    #expenseReason {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    /* 날짜와 시간 입력: 드롭다운 그룹 */
    .date-time-group {
      display: flex;
      gap: 5px;
    }
    .date-time-group select {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    /* 화폐별 금액 입력 영역 */
    #expenseCurrenciesContainer {
      margin-bottom: 15px;
      display: grid;
      gap: 10px;
    }
    .expense-currency-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .expense-currency-row select {
      width: 80px;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    .expense-currency-row input[type="number"] {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    .expense-currency-row button.remove-currency {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #d9534f;
    }
    #addExpenseCurrencyBtn {
      padding: 8px 12px;
      background: linear-gradient(45deg, #80deea, #4dd0e1);
      color: #333;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      cursor: pointer;
    }
    /* 분배 영역 */
    #expenseDistributionWrapper {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      margin-bottom: 15px;
    }
    #toggleAllBtn {
      padding: 8px 12px;
      background: linear-gradient(45deg, #80deea, #4dd0e1);
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #expenseDistributionContainer {
      display: grid;
      gap: 10px;
    }
    .distribution-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #fff;
    }
    .distribution-row .participant-name {
      min-width: 120px;
      font-size: 16px;
      font-weight: 500;
    }
    .currency-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      min-width: 100px;
    }
    .currency-group .group-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    .currency-group input.manual-override {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      text-align: right;
      background: #f9f9f9;
    }
    .currency-group span.computed-share {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      text-align: right;
      color: #333;
    }
    #addExpenseBtn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #ffcc80, #ffb74d);
      border: none;
      border-radius: var(--border-radius);
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    /* 세부 내역서 섹션 */
    #logSection {
      background: #fff;
      border: var(--input-border);
      border-radius: var(--border-radius);
      padding: 20px;
      flex: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #logSection h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .log-entry {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-entry header {
      font-size: 14px;
      margin-bottom: 5px;
      color: #555;
    }
    .log-entry .log-details {
      font-size: 14px;
      margin-bottom: 5px;
      color: #333;
      white-space: pre-wrap;
    }
    .log-entry .log-actions button {
      padding: 6px 10px;
      font-size: 14px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-right: 6px;
      background: linear-gradient(45deg, #aedff7, #87cefa);
      color: #333;
    }
    /* 모달 기본 스타일 (display:none 시작) */
    .modal {
      display: none;
      position: fixed;
      z-index: 500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #333;
    }
    /* 편집 모달 – 날짜/시간 드롭다운 */
    #editExpenseForm label {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .edit-time-inputs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .edit-time-inputs select {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    /* 설정 모달 */
    #settingsForm label {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    #settingsForm input[type="text"],
    #settingsForm select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
      margin-bottom: 10px;
    }
    #exchangeRatesContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .exchange-rate-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .exchange-rate-row select {
      width: 100px;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    .exchange-rate-row span {
      font-size: 16px;
      white-space: nowrap;
    }
    .exchange-rate-row input[type="number"] {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: var(--border-radius);
      background: #f9f9f9;
    }
    .exchange-rate-row button.remove-rate {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #d9534f;
    }
    #addExchangeRateBtn {
      padding: 8px 12px;
      background: linear-gradient(45deg, #a8e6cf, #dcedc1);
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      cursor: pointer;
      align-self: start;
    }
    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; }
      .expense-inputs { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- 좌측 사이드바 -->
    <div id="sidebar">
      <div id="participantContainer">
        <div id="participantSection">
          <h2>참가자 관리</h2>
          <input type="text" id="participantNameInput" placeholder="이름 입력 (예: 민찬)">
          <button id="addParticipantBtn">참가자 추가</button>
          <ul id="participantList"></ul>
        </div>
      </div>
      <div id="globalControls">
        <button id="copyReportBtn">정산서 복사</button>
        <button id="exportDataBtn">데이터 내보내기</button>
        <button id="resetDataBtn">데이터 초기화</button>
        <button id="settingsBtn">설정</button>
      </div>
    </div>
    <!-- 우측 메인 영역 -->
    <div id="main">
      <section id="expenseSection">
        <h2>정산 항목 추가</h2>
        <div class="expense-inputs">
          <div>
            <label for="expenseReason">정산 사유</label>
            <input type="text" id="expenseReason" placeholder="예: 밥값">
          </div>
          <div>
            <label>결제 날짜</label>
            <div class="date-time-group">
              <select id="expenseYear"></select>
              <select id="expenseMonth"></select>
              <select id="expenseDay"></select>
            </div>
          </div>
          <div>
            <label>결제 시각</label>
            <div class="date-time-group">
              <select id="expenseHour"></select>
              <select id="expenseMinute"></select>
            </div>
          </div>
        </div>
        <!-- 화폐별 금액 입력 -->
        <div id="expenseCurrenciesContainer"></div>
        <button id="addExpenseCurrencyBtn">화폐 추가</button>
        <!-- 분배 영역 -->
        <div id="expenseDistributionWrapper">
          <button id="toggleAllBtn">전체 선택</button>
          <div id="expenseDistributionContainer"></div>
        </div>
        <button id="addExpenseBtn">정산 항목 추가</button>
      </section>
      <section id="logSection">
        <h2>세부 내역서</h2>
        <div id="expenseLog"></div>
      </section>
    </div>
  </div>
  
  <!-- 모달: 정산 내역 수정 -->
  <div id="editExpenseModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeEditModal">&times;</span>
      <h3>정산 내역 수정</h3>
      <div id="editExpenseForm">
        <label>사유:
          <input type="text" id="editReason">
        </label>
        <label>비용 사용 날짜</label>
        <div class="date-time-group">
          <select id="editExpenseYear"></select>
          <select id="editExpenseMonth"></select>
          <select id="editExpenseDay"></select>
        </div>
        <label>비용 사용 시각 (24시간제)</label>
        <div class="date-time-group">
          <select id="editExpenseHour"></select>
          <select id="editExpenseMinute"></select>
        </div>
        <div id="editExpenseCurrenciesContainer"></div>
        <button id="addEditExpenseCurrencyBtn">화폐 추가</button>
        <div id="editDistributionWrapper">
          <button id="editToggleAllBtn">전체 선택</button>
          <div id="editDistributionContainer"></div>
        </div>
        <button id="saveEditExpenseBtn">저장</button>
        <button id="cancelEditExpenseBtn">취소</button>
      </div>
    </div>
  </div>
  
  <!-- 모달: 설정 -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeSettingsModal">&times;</span>
      <h3>설정</h3>
      <div id="settingsForm">
        <label>
          정산서 출력 방식:
          <select id="reportModeSelect">
            <option value="individual">통화별 금액만 표시</option>
            <option value="unified">통합 금액(환산)도 표시</option>
          </select>
        </label>
        <div id="unifiedSettings" style="display:none;">
          <label>
            기준 통화:
            <select id="baseCurrencySelect"></select>
          </label>
          <div id="exchangeRatesContainer"></div>
          <button id="addExchangeRateBtn">환율 추가</button>
        </div>
        <button id="saveSettingsBtn">저장</button>
        <button id="cancelSettingsBtn">취소</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      /* 전역 변수 및 데이터 모델 */
      let participants = [];
      let expenseLog = [];
      let participantIdCounter = 0;
      let expenseIdCounter = 0;
      let allSelected = false;
      let editingExpenseId = null;
      let settings = { reportMode: "individual", baseCurrency: "KRW", exchangeRates: {} };

      /* 통화 목록 및 헬퍼 함수 */
      const currencyList = [
        { code: "KRW", symbol: "₩", name: "한국 원", placement: "after" },
        { code: "USD", symbol: "$", name: "미국 달러", placement: "before" },
        { code: "PHP", symbol: "₱", name: "필리핀 페소", placement: "before" },
        { code: "JPY", symbol: "¥", name: "일본 엔", placement: "before" },
        { code: "AUD", symbol: "A$", name: "호주 달러", placement: "before" },
        { code: "BRL", symbol: "R$", name: "브라질 레알", placement: "before" },
        { code: "CAD", symbol: "C$", name: "캐나다 달러", placement: "before" },
        { code: "CHF", symbol: "CHF", name: "스위스 프랑", placement: "before" },
        { code: "CNY", symbol: "¥", name: "중국 위안", placement: "before" },
        { code: "DKK", symbol: "kr", name: "덴마크 크로네", placement: "after" },
        { code: "EUR", symbol: "€", name: "유로", placement: "before" },
        { code: "GBP", symbol: "£", name: "영국 파운드", placement: "before" },
        { code: "HKD", symbol: "HK$", name: "홍콩 달러", placement: "before" },
        { code: "INR", symbol: "₹", name: "인도 루피", placement: "before" },
        { code: "IDR", symbol: "Rp", name: "인도네시아 루피아", placement: "before" },
        { code: "MXN", symbol: "$", name: "멕시코 페소", placement: "before" },
        { code: "NOK", symbol: "kr", name: "노르웨이 크로네", placement: "after" },
        { code: "NZD", symbol: "NZ$", name: "뉴질랜드 달러", placement: "before" },
        { code: "RUB", symbol: "₽", name: "러시아 루블", placement: "after" },
        { code: "SEK", symbol: "kr", name: "스웨덴 크로나", placement: "after" },
        { code: "SGD", symbol: "S$", name: "싱가포르 달러", placement: "before" },
        { code: "THB", symbol: "฿", name: "태국 바트", placement: "before" },
        { code: "TRY", symbol: "₺", name: "터키 리라", placement: "before" },
        { code: "ZAR", symbol: "R", name: "남아프리카 랜드", placement: "before" }
      ];
      const uniqueCurrencies = [];
      currencyList.forEach(c => { if (!uniqueCurrencies.find(u => u.code === c.code)) uniqueCurrencies.push(c); });
      const priorityCodes = ["KRW", "USD", "PHP", "JPY"];
      const priority = uniqueCurrencies.filter(c => priorityCodes.includes(c.code));
      const others = uniqueCurrencies.filter(c => !priorityCodes.includes(c.code));
      others.sort((a, b) => a.code.localeCompare(b.code));
      const sortedCurrencies = [...priority, ...others];

      function getCurrencyFormat(code) {
        const cur = sortedCurrencies.find(c => c.code === code);
        return cur ? { symbol: cur.symbol, placement: cur.placement } : { symbol: "", placement: "before" };
      }
      function formatAmount(amount, code) {
        const formatted = Math.floor(amount).toLocaleString();
        const fmt = getCurrencyFormat(code);
        return fmt.placement === "before" ? fmt.symbol + formatted : formatted + fmt.symbol;
      }

      /* 데이터 영속성 */
      function saveData() {
        localStorage.setItem("participants", JSON.stringify(participants));
        localStorage.setItem("expenseLog", JSON.stringify(expenseLog));
        localStorage.setItem("participantIdCounter", participantIdCounter);
        localStorage.setItem("expenseIdCounter", expenseIdCounter);
        localStorage.setItem("settings", JSON.stringify(settings));
      }
      function loadData() {
        const pData = localStorage.getItem("participants");
        if (pData) participants = JSON.parse(pData);
        const eData = localStorage.getItem("expenseLog");
        if (eData) expenseLog = JSON.parse(eData);
        const pCounter = localStorage.getItem("participantIdCounter");
        if (pCounter) participantIdCounter = parseInt(pCounter);
        const eCounter = localStorage.getItem("expenseIdCounter");
        if (eCounter) expenseIdCounter = parseInt(eCounter);
        const sData = localStorage.getItem("settings");
        if (sData) settings = JSON.parse(sData);
      }

      /* 날짜/시간 드롭다운 생성 (현재년도 기준 ±5년) */
      function populateDateTimeSelectors(prefix) {
        const now = new Date();
        let currentYear = now.getFullYear();
        const yearSelect = document.getElementById(prefix + "Year");
        yearSelect.innerHTML = "";
        for (let y = currentYear - 5; y <= currentYear + 5; y++) {
          let opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        }
        const monthSelect = document.getElementById(prefix + "Month");
        monthSelect.innerHTML = "";
        for (let m = 1; m <= 12; m++) {
          let opt = document.createElement("option");
          opt.value = m.toString().padStart(2, '0');
          opt.textContent = m.toString().padStart(2, '0');
          monthSelect.appendChild(opt);
        }
        const daySelect = document.getElementById(prefix + "Day");
        daySelect.innerHTML = "";
        for (let d = 1; d <= 31; d++) {
          let opt = document.createElement("option");
          opt.value = d.toString().padStart(2, '0');
          opt.textContent = d.toString().padStart(2, '0');
          daySelect.appendChild(opt);
        }
        const hourSelect = document.getElementById(prefix + "Hour");
        hourSelect.innerHTML = "";
        for (let h = 0; h < 24; h++) {
          let opt = document.createElement("option");
          opt.value = h.toString().padStart(2, '0');
          opt.textContent = h.toString().padStart(2, '0');
          hourSelect.appendChild(opt);
        }
        const minuteSelect = document.getElementById(prefix + "Minute");
        minuteSelect.innerHTML = "";
        for (let i = 0; i < 60; i++) {
          let opt = document.createElement("option");
          opt.value = i.toString().padStart(2, '0');
          opt.textContent = i.toString().padStart(2, '0');
          minuteSelect.appendChild(opt);
        }
        yearSelect.value = currentYear;
        monthSelect.value = (now.getMonth() + 1).toString().padStart(2, '0');
        daySelect.value = now.getDate().toString().padStart(2, '0');
        hourSelect.value = now.getHours().toString().padStart(2, '0');
        minuteSelect.value = now.getMinutes().toString().padStart(2, '0');
      }
      populateDateTimeSelectors("expense");
      populateDateTimeSelectors("editExpense");

      /* 기준 통화 select 옵션 채우기 */
      function populateBaseCurrencySelect() {
        const baseSelect = document.getElementById("baseCurrencySelect");
        baseSelect.innerHTML = "";
        sortedCurrencies.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = `${c.code} (${c.name})`;
          baseSelect.appendChild(opt);
        });
        if (!settings.baseCurrency || !baseSelect.querySelector(`option[value="${settings.baseCurrency}"]`)) {
          settings.baseCurrency = "KRW";
        }
        baseSelect.value = settings.baseCurrency;
      }

      /* 참가자 목록 업데이트 */
      function updateParticipantList() {
        const list = document.getElementById("participantList");
        list.innerHTML = "";
        participants.forEach(p => {
          let totalsStr = "";
          if(settings.reportMode === "unified"){
            let unified = 0;
            for (const cur in p.totals) {
              totalsStr += `   - ${cur}: ${formatAmount(p.totals[cur], cur)}\n`;
              let rate = settings.exchangeRates[cur] || 1;
              unified += p.totals[cur] * rate;
            }
            if (totalsStr.trim() === "") totalsStr = "0";
            var header = `${p.name}(총액: ${formatAmount(unified, settings.baseCurrency)})\n` + totalsStr;
          } else {
            for (const cur in p.totals) {
              totalsStr += `   - ${cur}: ${formatAmount(p.totals[cur], cur)}\n`;
            }
            if (totalsStr.trim() === "") totalsStr = "0";
            var header = `${p.name}\n` + totalsStr;
          }
          const li = document.createElement("li");
          li.innerHTML = `<div class="p-header"><pre>${header}</pre></div>
                          <button data-id="${p.id}">&times;</button>`;
          li.querySelector("button").addEventListener("click", function() {
            participants = participants.filter(item => item.id !== parseInt(this.getAttribute("data-id")));
            updateParticipantList();
            updateExpenseDistribution();
            recalcTotals();
            saveData();
          });
          list.appendChild(li);
        });
      }

      /* 정산 항목 추가 – 화폐별 금액 입력 행 추가 (한 번에 1행씩 추가) */
      function addExpenseCurrencyRow(currency = sortedCurrencies[0].code, amount = "") {
        const row = document.createElement("div");
        row.className = "expense-currency-row";
        row.dataset.rowId = 'exr-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        const select = document.createElement("select");
        sortedCurrencies.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = c.code;
          select.appendChild(opt);
        });
        select.value = currency;
        select.addEventListener("change", updateExpenseDistribution);
        const inp = document.createElement("input");
        inp.type = "number";
        inp.min = "0";
        inp.placeholder = "금액 (예: 38000)";
        inp.value = amount;
        inp.addEventListener("input", updateExpenseDistribution);
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.className = "remove-currency";
        btn.addEventListener("click", () => { row.remove(); updateExpenseDistribution(); });
        row.appendChild(select);
        row.appendChild(inp);
        row.appendChild(btn);
        document.getElementById("expenseCurrenciesContainer").appendChild(row);
        updateExpenseDistribution();
      }
      addExpenseCurrencyRow();
      document.getElementById("addExpenseCurrencyBtn").addEventListener("click", () => { addExpenseCurrencyRow(); });

      /* 분배 영역 업데이트 */
      function updateExpenseDistribution() {
        const container = document.getElementById("expenseDistributionContainer");
        container.innerHTML = "";
        participants.forEach(p => {
          const row = document.createElement("div");
          row.className = "distribution-row";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.value = p.id;
          cb.className = "distribution-check";
          cb.addEventListener("change", updateComputedShares);
          const span = document.createElement("span");
          span.className = "participant-name";
          span.textContent = p.name;
          row.appendChild(cb);
          row.appendChild(span);
          const currRows = document.querySelectorAll("#expenseCurrenciesContainer .expense-currency-row");
          currRows.forEach(cr => {
            const group = document.createElement("div");
            group.className = "currency-group";
            group.dataset.rowId = cr.dataset.rowId;
            const curCode = cr.querySelector("select").value;
            const label = document.createElement("div");
            label.className = "group-label";
            label.textContent = curCode;
            const manual = document.createElement("input");
            manual.type = "number";
            manual.min = "0";
            manual.placeholder = "추가 금액";
            manual.className = "manual-override";
            manual.dataset.rowId = cr.dataset.rowId;
            manual.addEventListener("input", updateComputedShares);
            const comp = document.createElement("span");
            comp.className = "computed-share";
            comp.dataset.rowId = cr.dataset.rowId;
            comp.textContent = formatAmount(0, curCode);
            group.appendChild(label);
            group.appendChild(manual);
            group.appendChild(comp);
            row.appendChild(group);
          });
          container.appendChild(row);
        });
      }
      document.getElementById("toggleAllBtn").addEventListener("click", () => {
        allSelected = !allSelected;
        document.querySelectorAll(".distribution-check").forEach(cb => cb.checked = allSelected);
        document.getElementById("toggleAllBtn").textContent = allSelected ? "전체 해제" : "전체 선택";
        updateComputedShares();
      });

      /* computed share 재계산 */
      function updateComputedShares() {
        const currRows = document.querySelectorAll("#expenseCurrenciesContainer .expense-currency-row");
        currRows.forEach(cr => {
          const rowId = cr.dataset.rowId;
          const curCode = cr.querySelector("select").value;
          const total = parseFloat(cr.querySelector("input").value) || 0;
          const distRows = document.querySelectorAll("#expenseDistributionContainer .distribution-row");
          let selected = [];
          distRows.forEach(dr => { if (dr.querySelector("input.distribution-check").checked) selected.push(dr); });
          let manualSum = 0;
          selected.forEach(dr => {
            const val = parseFloat(dr.querySelector(`input.manual-override[data-row-id="${rowId}"]`).value) || 0;
            manualSum += val;
          });
          let remainder = total - manualSum;
          if (remainder < 0) remainder = 0;
          let share = selected.length > 0 ? remainder / selected.length : 0;
          selected.forEach(dr => {
            const val = parseFloat(dr.querySelector(`input.manual-override[data-row-id="${rowId}"]`).value) || 0;
            let compVal = share + val;
            dr.querySelector(`span.computed-share[data-row-id="${rowId}"]`).textContent = formatAmount(compVal, curCode);
          });
          distRows.forEach(dr => {
            if (!dr.querySelector("input.distribution-check").checked) {
              dr.querySelector(`span.computed-share[data-row-id="${rowId}"]`).textContent = formatAmount(0, curCode);
            }
          });
        });
      }

      /* 참가자 추가 버튼 */
      document.getElementById("addParticipantBtn").addEventListener("click", () => {
        const nameInput = document.getElementById("participantNameInput");
        const name = nameInput.value.trim();
        if (!name) {
          alert("참가자 이름을 입력하세요.");
          return;
        }
        participants.push({ id: participantIdCounter++, name: name, totals: {} });
        updateParticipantList();
        updateExpenseDistribution();
        recalcTotals();
        saveData();
        nameInput.value = "";
      });

      /* 정산 항목 추가 최종 처리 */
      document.getElementById("addExpenseBtn").addEventListener("click", () => {
        const reason = document.getElementById("expenseReason").value.trim();
        if (!reason) { alert("정산 사유를 입력하세요."); return; }
        const year = document.getElementById("expenseYear").value;
        const month = document.getElementById("expenseMonth").value;
        const day = document.getElementById("expenseDay").value;
        const hour = document.getElementById("expenseHour").value;
        const minute = document.getElementById("expenseMinute").value;
        if (!year || !month || !day || !hour || !minute) { alert("비용 사용 날짜와 시각을 모두 선택하세요."); return; }
        const expenseTime = `${year}-${month}-${day} ${hour}:${minute}`;
        const currRows = document.querySelectorAll("#expenseCurrenciesContainer .expense-currency-row");
        let currencies = [];
        currRows.forEach(cr => {
          const cur = cr.querySelector("select").value;
          const amt = parseFloat(cr.querySelector("input").value);
          if (!isNaN(amt) && amt > 0) { currencies.push({ currency: cur, amount: amt }); }
        });
        if (currencies.length === 0) { alert("적어도 하나의 금액(양수)을 입력하세요."); return; }
        let distribution = [];
        document.querySelectorAll("#expenseDistributionContainer .distribution-row").forEach(dr => {
          if (dr.querySelector("input.distribution-check").checked) {
            const pid = parseInt(dr.querySelector("input.distribution-check").value);
            let comp = {}, man = {};
            dr.querySelectorAll(".currency-group").forEach(group => {
              const cur = group.querySelector(".group-label").textContent;
              const compVal = parseFloat(group.querySelector("span.computed-share").textContent.replace(/\D/g,'')) || 0;
              const manVal = parseFloat(group.querySelector("input.manual-override").value) || 0;
              comp[cur] = compVal;
              man[cur] = manVal;
            });
            distribution.push({ participantId: pid, name: participants.find(p => p.id === pid).name, computed: comp, manual: man });
          }
        });
        if (distribution.length === 0) { alert("정산에 참여할 참가자를 선택하세요."); return; }
        let entry = {
          id: expenseIdCounter++,
          time: expenseTime,
          reason: reason,
          currencies: currencies,
          distribution: distribution
        };
        expenseLog.push(entry);
        recalcTotals();
        updateExpenseLog();
        updateParticipantList();
        document.getElementById("expenseReason").value = "";
        populateDateTimeSelectors("expense");
        document.getElementById("expenseCurrenciesContainer").innerHTML = "";
        addExpenseCurrencyRow();
        updateExpenseDistribution();
        allSelected = false;
        document.getElementById("toggleAllBtn").textContent = "전체 선택";
        saveData();
      });

      function recalcTotals() {
        participants.forEach(p => p.totals = {});
        expenseLog.forEach(entry => {
          entry.distribution.forEach(d => {
            for (const cur in d.computed) {
              const p = participants.find(p => p.id === d.participantId);
              if (p) p.totals[cur] = (p.totals[cur] || 0) + d.computed[cur];
            }
          });
        });
      }

      function updateExpenseLog() {
        const logEl = document.getElementById("expenseLog");
        logEl.innerHTML = "";
        expenseLog.slice().reverse().forEach(entry => {
          const div = document.createElement("div");
          div.className = "log-entry";
          const header = document.createElement("header");
          header.textContent = `${entry.time} ${entry.reason} ` +
            entry.currencies.map(c => `${c.currency}: ${formatAmount(c.amount, c.currency)}`).join(" ");
          div.appendChild(header);
          let details = "";
          entry.distribution.forEach(d => {
            let line = `${d.name}:`;
            for (const cur in d.computed) {
              line += ` ${cur}: ${formatAmount(d.computed[cur], cur)}`;
            }
            details += line + "\n";
          });
          const detailDiv = document.createElement("div");
          detailDiv.className = "log-details";
          detailDiv.innerHTML = `<pre>${details}</pre>`;
          div.appendChild(detailDiv);
          const actDiv = document.createElement("div");
          actDiv.className = "log-actions";
          const editBtn = document.createElement("button");
          editBtn.textContent = "수정";
          editBtn.dataset.id = entry.id;
          editBtn.addEventListener("click", () => { openEditModal(entry.id); });
          const delBtn = document.createElement("button");
          delBtn.textContent = "삭제";
          delBtn.dataset.id = entry.id;
          delBtn.addEventListener("click", () => { if(confirm("이 항목을 삭제하시겠습니까?")) { deleteExpense(entry.id); } });
          actDiv.appendChild(editBtn);
          actDiv.appendChild(delBtn);
          div.appendChild(actDiv);
          logEl.appendChild(div);
        });
      }

      function deleteExpense(id) {
        expenseLog = expenseLog.filter(e => e.id !== id);
        recalcTotals();
        updateExpenseLog();
        updateParticipantList();
        saveData();
      }

      document.getElementById("copyReportBtn").addEventListener("click", () => {
        let rep = "";
        participants.forEach(p => {
          rep += "--------------------------\n";
          let unified = 0;
          if(settings.reportMode === "unified"){
            for (const cur in p.totals) {
              let rate = settings.exchangeRates[cur] || 1;
              unified += p.totals[cur] * rate;
            }
            rep += `${p.name}(총액: ${formatAmount(unified, settings.baseCurrency)})\n`;
          } else {
            rep += `${p.name}\n`;
          }
          for (const cur in p.totals) {
            rep += `   - ${cur}: ${formatAmount(p.totals[cur], cur)}\n`;
          }
          rep += "\n";
          expenseLog.forEach(entry => {
            const d = entry.distribution.find(item => item.participantId === p.id);
            if (d) {
              let dt = entry.time;
              let line = `${dt} ${entry.reason}`;
              for (const cur in d.computed) {
                line += ` ${cur}: ${formatAmount(d.computed[cur], cur)}`;
              }
              rep += line + "\n";
            }
          });
          rep += "--------------------------\n";
        });
        copyToClipboard(rep);
        alert("정산서가 클립보드에 복사되었습니다.");
      });

      function copyToClipboard(text) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      document.getElementById("exportDataBtn").addEventListener("click", () => {
        const data = { participants, expenseLog, participantIdCounter, expenseIdCounter, settings };
        const str = JSON.stringify(data, null, 2);
        const blob = new Blob([str], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "expense_data.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById("resetDataBtn").addEventListener("click", () => {
        if (confirm("모든 데이터를 초기화하시겠습니까?")) {
          localStorage.clear();
          location.reload();
        }
      });

      /* 설정 모달 */
      document.getElementById("settingsBtn").addEventListener("click", () => {
        document.getElementById("reportModeSelect").value = settings.reportMode;
        document.getElementById("unifiedSettings").style.display = settings.reportMode === "unified" ? "block" : "none";
        populateBaseCurrencySelect();
        document.getElementById("exchangeRatesContainer").innerHTML = "";
        for (const cur in settings.exchangeRates) { addExchangeRateRow(cur, settings.exchangeRates[cur]); }
        document.getElementById("settingsModal").style.display = "flex";
      });
      document.getElementById("closeSettingsModal").addEventListener("click", () => {
        document.getElementById("settingsModal").style.display = "none";
      });
      document.getElementById("cancelSettingsBtn").addEventListener("click", () => {
        document.getElementById("settingsModal").style.display = "none";
      });
      document.getElementById("reportModeSelect").addEventListener("change", () => {
        document.getElementById("unifiedSettings").style.display = document.getElementById("reportModeSelect").value === "unified" ? "block" : "none";
      });
      function addExchangeRateRow(currency = sortedCurrencies[1].code, rate = "") {
        const row = document.createElement("div");
        row.className = "exchange-rate-row";
        const select = document.createElement("select");
        sortedCurrencies.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = c.code;
          select.appendChild(opt);
        });
        select.value = currency;
        const left = document.createElement("span");
        left.textContent = "1,000";
        const mid = document.createElement("span");
        mid.textContent = " = ";
        const inp = document.createElement("input");
        inp.type = "number";
        inp.min = "0";
        inp.placeholder = "기준 통화 금액";
        inp.value = rate;
        const baseLbl = document.createElement("span");
        baseLbl.textContent = document.getElementById("baseCurrencySelect").value;
        const remBtn = document.createElement("button");
        remBtn.textContent = "×";
        remBtn.className = "remove-rate";
        remBtn.addEventListener("click", () => { row.remove(); });
        row.appendChild(select);
        row.appendChild(left);
        row.appendChild(mid);
        row.appendChild(inp);
        row.appendChild(baseLbl);
        row.appendChild(remBtn);
        document.getElementById("exchangeRatesContainer").appendChild(row);
      }
      document.getElementById("addExchangeRateBtn").addEventListener("click", () => { addExchangeRateRow(); });
      document.getElementById("saveSettingsBtn").addEventListener("click", () => {
        settings.reportMode = document.getElementById("reportModeSelect").value;
        settings.baseCurrency = document.getElementById("baseCurrencySelect").value;
        let rates = {};
        document.querySelectorAll(".exchange-rate-row").forEach(row => {
          const cur = row.querySelector("select").value;
          const val = parseFloat(row.querySelector("input").value) || 1;
          rates[cur] = val;
        });
        settings.exchangeRates = rates;
        saveData();
        updateParticipantList();
        updateExpenseLog();
        document.getElementById("settingsModal").style.display = "none";
      });

      /* 편집 모달 */
      function populateEditSelectors() { populateDateTimeSelectors("editExpense"); }
      function openEditModal(id) {
        editingExpenseId = id;
        const entry = expenseLog.find(e => e.id === id);
        if (!entry) return;
        document.getElementById("editReason").value = entry.reason;
        let parts = entry.time.split(" ");
        if(parts.length >= 2) {
          let dateParts = parts[0].split("-");
          let timeParts = parts[1].split(":");
          document.getElementById("editExpenseYear").value = dateParts[0];
          document.getElementById("editExpenseMonth").value = dateParts[1];
          document.getElementById("editExpenseDay").value = dateParts[2];
          document.getElementById("editExpenseHour").value = timeParts[0];
          document.getElementById("editExpenseMinute").value = timeParts[1];
        }
        populateEditSelectors();
        document.getElementById("editExpenseCurrenciesContainer").innerHTML = "";
        entry.currencies.forEach(c => { addEditExpenseCurrencyRow(c.currency, c.amount); });
        updateEditDistribution();
        document.querySelectorAll("#editDistributionContainer .distribution-row").forEach(dr => {
          const pid = parseInt(dr.querySelector("input.distribution-check").value);
          const d = entry.distribution.find(item => item.participantId === pid);
          if (d) {
            dr.querySelectorAll(".currency-group").forEach(group => {
              const cur = group.querySelector(".group-label").textContent;
              const inp = group.querySelector("input.manual-override");
              if (d.manual[cur] !== undefined) { inp.value = d.manual[cur]; }
            });
          }
        });
        updateEditComputedShares();
        document.getElementById("editExpenseModal").style.display = "flex";
      }
      function closeEditModal() {
        editingExpenseId = null;
        document.getElementById("editExpenseModal").style.display = "none";
        document.getElementById("editReason").value = "";
        document.getElementById("editExpenseCurrenciesContainer").innerHTML = "";
        document.getElementById("editDistributionContainer").innerHTML = "";
      }
      document.getElementById("closeEditModal").addEventListener("click", closeEditModal);
      document.getElementById("cancelEditExpenseBtn").addEventListener("click", closeEditModal);
      function addEditExpenseCurrencyRow(currency, amount) {
        const row = document.createElement("div");
        row.className = "expense-currency-row";
        row.dataset.rowId = 'edit-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        const select = document.createElement("select");
        sortedCurrencies.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = c.code;
          select.appendChild(opt);
        });
        select.value = currency;
        select.addEventListener("change", updateEditDistribution);
        const inp = document.createElement("input");
        inp.type = "number";
        inp.min = "0";
        inp.placeholder = "금액 (예: 38000)";
        inp.value = amount;
        inp.addEventListener("input", updateEditDistribution);
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.className = "remove-currency";
        btn.addEventListener("click", () => { row.remove(); updateEditDistribution(); });
        row.appendChild(select);
        row.appendChild(inp);
        row.appendChild(btn);
        document.getElementById("editExpenseCurrenciesContainer").appendChild(row);
        updateEditDistribution();
      }
      document.getElementById("addEditExpenseCurrencyBtn").addEventListener("click", () => { addEditExpenseCurrencyRow(sortedCurrencies[0].code, ""); });
      function updateEditDistribution() {
        const container = document.getElementById("editDistributionContainer");
        container.innerHTML = "";
        participants.forEach(p => {
          const row = document.createElement("div");
          row.className = "distribution-row";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.value = p.id;
          cb.className = "distribution-check";
          cb.addEventListener("change", updateEditComputedShares);
          const span = document.createElement("span");
          span.className = "participant-name";
          span.textContent = p.name;
          row.appendChild(cb);
          row.appendChild(span);
          const currRows = document.querySelectorAll("#editExpenseCurrenciesContainer .expense-currency-row");
          currRows.forEach(cr => {
            const group = document.createElement("div");
            group.className = "currency-group";
            group.dataset.rowId = cr.dataset.rowId;
            const curCode = cr.querySelector("select").value;
            const label = document.createElement("div");
            label.className = "group-label";
            label.textContent = curCode;
            const manual = document.createElement("input");
            manual.type = "number";
            manual.min = "0";
            manual.placeholder = "추가 금액";
            manual.className = "manual-override";
            manual.dataset.rowId = cr.dataset.rowId;
            manual.addEventListener("input", updateEditComputedShares);
            const comp = document.createElement("span");
            comp.className = "computed-share";
            comp.dataset.rowId = cr.dataset.rowId;
            comp.textContent = formatAmount(0, curCode);
            group.appendChild(label);
            group.appendChild(manual);
            group.appendChild(comp);
            row.appendChild(group);
          });
          container.appendChild(row);
        });
      }
      
      function updateEditComputedShares() {
        const currRows = document.querySelectorAll("#editExpenseCurrenciesContainer .expense-currency-row");
        currRows.forEach(cr => {
          const rowId = cr.dataset.rowId;
          const curCode = cr.querySelector("select").value;
          const total = parseFloat(cr.querySelector("input").value) || 0;
          const rows = document.querySelectorAll("#editDistributionContainer .distribution-row");
          let selected = [];
          rows.forEach(dr => { if (dr.querySelector("input.distribution-check").checked) selected.push(dr); });
          let manualSum = 0;
          selected.forEach(dr => {
            const val = parseFloat(dr.querySelector(`input.manual-override[data-row-id="${rowId}"]`).value) || 0;
            manualSum += val;
          });
          let remainder = total - manualSum;
          if (remainder < 0) remainder = 0;
          let share = selected.length > 0 ? remainder / selected.length : 0;
          selected.forEach(dr => {
            const val = parseFloat(dr.querySelector(`input.manual-override[data-row-id="${rowId}"]`).value) || 0;
            let compVal = share + val;
            dr.querySelector(`span.computed-share[data-row-id="${rowId}"]`).textContent = formatAmount(compVal, curCode);
          });
          rows.forEach(dr => {
            if (!dr.querySelector("input.distribution-check").checked) {
              dr.querySelector(`span.computed-share[data-row-id="${rowId}"]`).textContent = formatAmount(0, curCode);
            }
          });
        });
      }
      
      /* 페이지 로드시 모달 숨김 */
      window.onload = function() {
        document.getElementById("settingsModal").style.display = "none";
        document.getElementById("editExpenseModal").style.display = "none";
      };
      
    }); // End of DOMContentLoaded
  </script>
</body>
</html>
