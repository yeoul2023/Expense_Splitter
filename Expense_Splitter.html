<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>정산 프로그램 - Ultimate Edition (휴양지 Edition)</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 기본 리셋 및 폰트 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #eee;
    }
    /* 입력 필드 배경 그라데이션 */
    input[type="text"],
    input[type="number"] {
      background: linear-gradient(180deg, #F5F5F5, #E0E0E0);
      color: inherit;
    }
    body.dark-mode input[type="text"],
    body.dark-mode input[type="number"] {
      background: linear-gradient(180deg, #424242, #616161);
      color: #fff;
    }
    
    /* 기본 테두리 및 버튼 변수 */
    :root {
      --input-border: 1px solid rgba(0,0,0,0.2);
    }
    
    /* 전체 레이아웃 */
    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* 좌측 사이드바 */
    #sidebar {
      width: 320px;
      background: rgba(255, 255, 255, 0.85);
      border-right: 1px solid rgba(255,255,255,0.8);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow-y: auto;
      backdrop-filter: blur(4px);
      transition: background 0.3s, border-color 0.3s;
    }
    body.dark-mode #sidebar {
      background: rgba(0, 0, 0, 0.75);
      border-color: rgba(255,255,255,0.3);
    }
    
    /* 참가자 관리 영역 */
    #participantSection h2 {
      font-size: 22px;
      margin-bottom: 10px;
    }
    #participantSection input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: 4px;
      margin-bottom: 10px;
    }
    /* 참가자 추가 버튼 - 파스텔 민트 그라데이션 */
    #addParticipantBtn {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background: linear-gradient(45deg, #a8e6cf, #dcedc1);
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    #participantList {
      list-style: none;
    }
    #participantList li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
      background: #fff;
      white-space: nowrap;
      font-size: 16px;
    }
    body.dark-mode #participantList li {
      background: rgba(0,0,0,0.8);
      border-color: rgba(255,255,255,0.2);
    }
    #participantList li button {
      background: transparent;
      border: none;
      color: #333;
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
    }
    body.dark-mode #participantList li button {
      color: #eee;
    }
    
    /* 글로벌 컨트롤 영역 */
    #globalControls {
      margin-top: 20px;
    }
    #globalControls select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: 4px;
      margin-bottom: 10px;
      background: #fff;
      color: inherit;
    }
    /* 기능별 버튼 색상 */
    #copyReportBtn {
      background: linear-gradient(45deg, #aedff7, #87cefa);
      color: #333;
    }
    #exportDataBtn {
      background: linear-gradient(45deg, #d1c4e9, #b39ddb);
      color: #333;
    }
    #resetDataBtn {
      background: linear-gradient(45deg, #ffccd2, #ef9a9a);
      color: #333;
    }
    #toggleDarkModeBtn {
      background: linear-gradient(45deg, #cfd8dc, #b0bec5);
      color: #333;
    }
    #globalControls button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    /* 우측 메인 영역 */
    #main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    /* 정산 항목 추가 영역 */
    #expenseSection {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      padding: 20px;
    }
    body.dark-mode #expenseSection {
      background: rgba(0,0,0,0.75);
      border-color: rgba(255,255,255,0.3);
    }
    #expenseSection h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .expense-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .expense-inputs input[type="text"],
    .expense-inputs input[type="number"] {
      flex: 1 1 200px;
      padding: 8px 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: 4px;
      background: linear-gradient(180deg, #F5F5F5, #E0E0E0);
      color: inherit;
    }
    .expense-participants-wrapper {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    /* 전체 선택 버튼: 부드러운 청록 계열 */
    #toggleAllBtn {
      padding: 8px 12px;
      background: linear-gradient(45deg, #80deea, #4dd0e1);
      color: #333;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    #expenseParticipantsContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .expense-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: var(--input-border);
      border-radius: 4px;
      background: #fff;
    }
    body.dark-mode .expense-row {
      background: rgba(0,0,0,0.8);
      border-color: rgba(255,255,255,0.2);
    }
    .expense-row label {
      flex: 1;
      font-size: 16px;
      cursor: pointer;
    }
    .expense-row input[type="checkbox"] {
      margin-right: 6px;
    }
    .expense-row input.manual-override {
      width: 200px;
      height: 40px;
      padding: 6px 10px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: 4px;
      text-align: right;
      background: linear-gradient(180deg, #F5F5F5, #E0E0E0);
      color: inherit;
    }
    .expense-row input.manual-override::-webkit-inner-spin-button,
    .expense-row input.manual-override::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .expense-row input.manual-override { -moz-appearance: textfield; }
    .expense-row span.computed-share {
      width: 100px;
      font-size: 16px;
      text-align: right;
      color: #333;
    }
    /* 정산 항목 추가 버튼: 파스텔 오렌지 계열 */
    #addExpenseBtn {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background: linear-gradient(45deg, #ffcc80, #ffb74d);
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    /* 세부 내역서 섹션 */
    #logSection {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    body.dark-mode #logSection {
      background: rgba(0,0,0,0.75);
      border-color: rgba(255,255,255,0.3);
    }
    #logSection h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .log-entry {
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 10px 0;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-entry header {
      font-size: 14px;
      margin-bottom: 5px;
    }
    .log-entry .log-details {
      font-size: 16px;
      margin-bottom: 5px;
    }
    .log-entry .log-details span {
      margin-right: 10px;
    }
    .log-entry .log-actions button {
      padding: 4px 8px;
      font-size: 14px;
      border: var(--btn-border);
      border-radius: 4px;
      cursor: pointer;
      margin-right: 6px;
      background: linear-gradient(45deg, #aedff7, #87cefa);
      color: #333;
    }
    
    /* 모달 (정산 내역 수정) */
    .modal {
      display: none;
      position: fixed;
      z-index: 500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
    }
    #editExpenseForm label {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
    }
    #editExpenseForm input[type="text"],
    #editExpenseForm input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 16px;
      margin-top: 4px;
      border: var(--input-border);
      border-radius: 4px;
      background: linear-gradient(180deg, #F5F5F5, #E0E0E0);
      color: inherit;
    }
    #editDistribution {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    #editDistribution .edit-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: var(--input-border);
    }
    #editDistribution .edit-row:last-child { border-bottom: none; }
    #editDistribution span { flex: 1; font-size: 16px; }
    #editDistribution input {
      width: 100px;
      padding: 4px 6px;
      font-size: 16px;
      border: var(--input-border);
      border-radius: 4px;
      text-align: right;
      background: linear-gradient(180deg, #F5F5F5, #E0E0E0);
      color: inherit;
    }
    #saveEditBtn, #cancelEditBtn {
      padding: 10px 15px;
      font-size: 16px;
      border: var(--btn-border);
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }
    #saveEditBtn {
      background: linear-gradient(45deg, #a8e6cf, #dcedc1);
      color: #333;
    }
    #cancelEditBtn {
      background: linear-gradient(45deg, #cfd8dc, #b0bec5);
      color: #333;
      margin-left: 10px;
    }
    
    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar { width: 100%; border-right: none; border-bottom: var(--input-border); }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- 좌측 사이드바 -->
    <div id="sidebar">
      <!-- 참가자 관리 영역 -->
      <div id="participantSection">
        <h2>참가자 관리</h2>
        <input type="text" id="participantNameInput" placeholder="이름 입력 (예: 민찬)">
        <button id="addParticipantBtn">참가자 추가</button>
        <ul id="participantList"></ul>
      </div>
      <!-- 글로벌 컨트롤 영역 -->
      <div id="globalControls">
        <select id="currencySelect"></select>
        <button id="copyReportBtn">정산서 복사</button>
        <button id="exportDataBtn">데이터 내보내기</button>
        <button id="resetDataBtn">데이터 초기화</button>
        <button id="toggleDarkModeBtn">다크 모드</button>
      </div>
    </div>
    <!-- 우측 메인 영역 -->
    <div id="main">
      <!-- 정산 항목 추가 섹션 -->
      <section id="expenseSection">
        <h2>정산 항목 추가</h2>
        <div class="expense-inputs">
          <input type="text" id="expenseReason" placeholder="정산 사유 (예: 밥값)">
          <input type="number" id="expenseTotal" placeholder="총 금액 (예: 38000)" min="0">
        </div>
        <div class="expense-participants-wrapper">
          <button id="toggleAllBtn">전체 선택</button>
          <div id="expenseParticipantsContainer"></div>
        </div>
        <button id="addExpenseBtn">정산 항목 추가</button>
      </section>
      <!-- 세부 내역서 섹션 -->
      <section id="logSection">
        <h2>세부 내역서</h2>
        <div id="expenseLog"></div>
      </section>
    </div>
  </div>
  
  <!-- 모달: 정산 내역 수정 -->
  <div id="editExpenseModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>정산 내역 수정</h3>
      <div id="editExpenseForm">
        <label>사유:
          <input type="text" id="editReason">
        </label>
        <label>총 금액:
          <input type="number" id="editTotal" min="0">
        </label>
        <div id="editDistribution"></div>
        <button id="saveEditBtn">저장</button>
        <button id="cancelEditBtn">취소</button>
      </div>
    </div>
  </div>
  
  <script>
    /***********************************
     * 통화 선택 옵션 채우기
    ***********************************/
    const currencyList = [
      { code: "KRW", symbol: "₩", name: "한국 원", placement: "after" },
      { code: "USD", symbol: "$", name: "미국 달러", placement: "before" },
      { code: "PHP", symbol: "₱", name: "필리핀 페소", placement: "before" },
      { code: "JPY", symbol: "¥", name: "일본 엔", placement: "before" },
      { code: "AUD", symbol: "A$", name: "호주 달러", placement: "before" },
      { code: "BRL", symbol: "R$", name: "브라질 레알", placement: "before" },
      { code: "CAD", symbol: "C$", name: "캐나다 달러", placement: "before" },
      { code: "CHF", symbol: "CHF", name: "스위스 프랑", placement: "before" },
      { code: "CNY", symbol: "¥", name: "중국 위안", placement: "before" },
      { code: "DKK", symbol: "kr", name: "덴마크 크로네", placement: "after" },
      { code: "EUR", symbol: "€", name: "유로", placement: "before" },
      { code: "GBP", symbol: "£", name: "영국 파운드", placement: "before" },
      { code: "HKD", symbol: "HK$", name: "홍콩 달러", placement: "before" },
      { code: "INR", symbol: "₹", name: "인도 루피", placement: "before" },
      { code: "IDR", symbol: "Rp", name: "인도네시아 루피아", placement: "before" },
      { code: "MXN", symbol: "$", name: "멕시코 페소", placement: "before" },
      { code: "NOK", symbol: "kr", name: "노르웨이 크로네", placement: "after" },
      { code: "NZD", symbol: "NZ$", name: "뉴질랜드 달러", placement: "before" },
      { code: "RUB", symbol: "₽", name: "러시아 루블", placement: "after" },
      { code: "SEK", symbol: "kr", name: "스웨덴 크로나", placement: "after" },
      { code: "SGD", symbol: "S$", name: "싱가포르 달러", placement: "before" },
      { code: "THB", symbol: "฿", name: "태국 바트", placement: "before" },
      { code: "TRY", symbol: "₺", name: "터키 리라", placement: "before" },
      { code: "ZAR", symbol: "R", name: "남아프리카 랜드", placement: "before" }
    ];
    const uniqueCurrencies = [];
    currencyList.forEach(c => { if (!uniqueCurrencies.find(u => u.code === c.code)) uniqueCurrencies.push(c); });
    const priorityCodes = ["KRW", "USD", "PHP", "JPY"];
    const priority = uniqueCurrencies.filter(c => priorityCodes.includes(c.code));
    const others = uniqueCurrencies.filter(c => !priorityCodes.includes(c.code));
    others.sort((a, b) => a.code.localeCompare(b.code));
    const sortedCurrencies = [...priority, ...others];
    
    let currentCurrency = sortedCurrencies[0].code;
    function getCurrencyFormat(code) {
      const cur = sortedCurrencies.find(c => c.code === code);
      return cur ? { symbol: cur.symbol, placement: cur.placement } : { symbol: "", placement: "before" };
    }
    
    /***********************************
     * 데이터 영속성 관련 함수
    ***********************************/
    function saveData() {
      localStorage.setItem("participants", JSON.stringify(participants));
      localStorage.setItem("expenseLog", JSON.stringify(expenseLog));
      localStorage.setItem("participantIdCounter", participantIdCounter);
      localStorage.setItem("expenseIdCounter", expenseIdCounter);
    }
    function loadData() {
      const pData = localStorage.getItem("participants");
      if (pData) participants = JSON.parse(pData);
      const eData = localStorage.getItem("expenseLog");
      if (eData) expenseLog = JSON.parse(eData);
      const pCounter = localStorage.getItem("participantIdCounter");
      if (pCounter) participantIdCounter = parseInt(pCounter);
      const eCounter = localStorage.getItem("expenseIdCounter");
      if (eCounter) expenseIdCounter = parseInt(eCounter);
    }
    
    /***********************************
     * 헬퍼 함수 (금액 포맷)
    ***********************************/
    function formatIndividual(amount) {
      const formatted = Math.floor(amount).toLocaleString();
      const fmt = getCurrencyFormat(currentCurrency);
      return fmt.placement === "before" ? fmt.symbol + formatted : formatted + fmt.symbol;
    }
    function formatTotal(amount) {
      const formatted = Math.floor(amount).toLocaleString();
      const fmt = getCurrencyFormat(currentCurrency);
      return fmt.placement === "before" ? fmt.symbol + formatted : formatted + fmt.symbol;
    }
    
    /***********************************
     * 전역 변수 및 데이터 모델
    ***********************************/
    let participants = [];
    let expenseLog = [];
    let participantIdCounter = 0;
    let expenseIdCounter = 0;
    let allSelected = false;
    let editingExpenseId = null;
    
    /***********************************
     * DOM 요소 캐싱
    ***********************************/
    const participantNameInput = document.getElementById("participantNameInput");
    const addParticipantBtn = document.getElementById("addParticipantBtn");
    const participantListEl = document.getElementById("participantList");
    const currencySelect = document.getElementById("currencySelect");
    
    const expenseReasonInput = document.getElementById("expenseReason");
    const expenseTotalInput = document.getElementById("expenseTotal");
    const toggleAllBtn = document.getElementById("toggleAllBtn");
    const expenseParticipantsContainer = document.getElementById("expenseParticipantsContainer");
    const addExpenseBtn = document.getElementById("addExpenseBtn");
    
    const expenseLogEl = document.getElementById("expenseLog");
    const copyReportBtn = document.getElementById("copyReportBtn");
    const exportDataBtn = document.getElementById("exportDataBtn");
    const resetDataBtn = document.getElementById("resetDataBtn");
    const toggleDarkModeBtn = document.getElementById("toggleDarkModeBtn");
    
    const editExpenseModal = document.getElementById("editExpenseModal");
    const closeModalBtn = document.querySelector(".close-modal");
    const editReasonInput = document.getElementById("editReason");
    const editTotalInput = document.getElementById("editTotal");
    const editDistributionEl = document.getElementById("editDistribution");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    
    /***********************************
     * 통화 선택 옵션 채우기
    ***********************************/
    function populateCurrencySelect() {
      currencySelect.innerHTML = "";
      sortedCurrencies.forEach(c => {
        const option = document.createElement("option");
        option.value = c.code;
        option.textContent = `${c.code} (${c.name})`;
        currencySelect.appendChild(option);
      });
      currencySelect.value = currentCurrency;
    }
    populateCurrencySelect();
    
    /***********************************
     * 참가자 관리 함수
    ***********************************/
    function addParticipant(name) {
      const participant = {
        id: participantIdCounter++,
        name: name,
        total: 0
      };
      participants.push(participant);
      updateParticipantList();
      updateExpenseParticipants();
      updateTotalDisplay();
      saveData();
      // 입력 필드 자동 클리어
      participantNameInput.value = "";
    }
    function removeParticipant(id) {
      participants = participants.filter(p => p.id !== id);
      updateParticipantList();
      updateExpenseParticipants();
      recalcParticipantsTotals();
      updateExpenseLog();
      updateTotalDisplay();
      saveData();
    }
    function updateParticipantList() {
      participantListEl.innerHTML = "";
      participants.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${p.name} (<strong>${formatTotal(p.total)}</strong>)</span>
                        <button data-id="${p.id}">&times;</button>`;
        li.querySelector("button").addEventListener("click", function() {
          removeParticipant(parseInt(this.getAttribute("data-id")));
        });
        participantListEl.appendChild(li);
      });
    }
    
    /***********************************
     * 정산 항목 추가 영역 관련
    ***********************************/
    function updateExpenseParticipants() {
      expenseParticipantsContainer.innerHTML = "";
      participants.forEach(p => {
        const div = document.createElement("div");
        div.className = "expense-row";
        div.innerHTML = `
          <label>
            <input type="checkbox" class="expense-check" value="${p.id}"> ${p.name}
          </label>
          <input type="number" class="manual-override" placeholder="추가 금액 (예: 8000)" value="" step="1">
          <span class="computed-share">0${getCurrencyFormat(currentCurrency).symbol}</span>
        `;
        const checkbox = div.querySelector(".expense-check");
        const manualInput = div.querySelector(".manual-override");
        checkbox.addEventListener("change", updateComputedShares);
        manualInput.addEventListener("input", updateComputedShares);
        expenseParticipantsContainer.appendChild(div);
      });
    }
    toggleAllBtn.addEventListener("click", () => {
      allSelected = !allSelected;
      const checkboxes = document.querySelectorAll(".expense-check");
      checkboxes.forEach(cb => cb.checked = allSelected);
      toggleAllBtn.textContent = allSelected ? "전체 해제" : "전체 선택";
      updateComputedShares();
    });
    expenseTotalInput.addEventListener("input", updateComputedShares);
    function updateComputedShares() {
      const totalValue = parseFloat(expenseTotalInput.value) || 0;
      const rows = document.querySelectorAll(".expense-row");
      let selectedRows = [];
      rows.forEach(row => {
        const cb = row.querySelector(".expense-check");
        if(cb.checked) selectedRows.push(row);
      });
      let manualSum = 0;
      selectedRows.forEach(row => {
        const manualVal = parseFloat(row.querySelector(".manual-override").value) || 0;
        manualSum += manualVal;
      });
      let remainder = totalValue - manualSum;
      if(remainder < 0) remainder = 0;
      const n = selectedRows.length;
      if(n > 0) {
         const share = remainder / n;
         selectedRows.forEach(row => {
           const manualVal = parseFloat(row.querySelector(".manual-override").value) || 0;
           const computed = share + manualVal;
           row.querySelector(".computed-share").textContent = formatIndividual(computed);
         });
      }
      rows.forEach(row => {
         const cb = row.querySelector(".expense-check");
         if(!cb.checked) {
           row.querySelector(".computed-share").textContent = "0" + getCurrencyFormat(currentCurrency).symbol;
         }
      });
    }
    
    /***********************************
     * 정산 항목 추가 (로그 기록 및 참가자 총액 업데이트)
    ***********************************/
    addExpenseBtn.addEventListener("click", () => {
      const reason = expenseReasonInput.value.trim();
      const totalExpense = parseFloat(expenseTotalInput.value);
      if (!reason || isNaN(totalExpense) || totalExpense <= 0) {
        alert("정산 사유와 올바른 총 금액을 입력하세요.");
        return;
      }
      const rows = document.querySelectorAll(".expense-row");
      let distribution = [];
      let selectedRows = [];
      rows.forEach(row => {
        const cb = row.querySelector(".expense-check");
        if(cb.checked) selectedRows.push(row);
      });
      if(selectedRows.length === 0) {
        alert("정산에 참여할 참가자를 선택하세요.");
        return;
      }
      let manualSum = 0;
      selectedRows.forEach(row => {
        const manualVal = parseFloat(row.querySelector(".manual-override").value) || 0;
        manualSum += manualVal;
      });
      let remainder = totalExpense - manualSum;
      if(remainder < 0) remainder = 0;
      const n = selectedRows.length;
      const share = n > 0 ? (remainder / n) : 0;
      selectedRows.forEach(row => {
        const participantId = parseInt(row.querySelector(".expense-check").value);
        const manualVal = parseFloat(row.querySelector(".manual-override").value) || 0;
        const computed = share + manualVal;
        distribution.push({
          participantId,
          name: participants.find(p => p.id === participantId).name,
          manual: manualVal,
          computed: computed
        });
      });
      const expenseEntry = {
        id: expenseIdCounter++,
        time: new Date().toLocaleString(),
        reason: reason,
        total: totalExpense,
        distribution: distribution
      };
      expenseLog.push(expenseEntry);
      recalcParticipantsTotals();
      updateExpenseLog();
      updateParticipantList();
      updateTotalDisplay();
      // 입력 필드 클리어
      expenseReasonInput.value = "";
      expenseTotalInput.value = "";
      updateComputedShares();
      const allRows = document.querySelectorAll(".expense-row");
      allRows.forEach(row => {
        row.querySelector(".expense-check").checked = false;
        row.querySelector(".manual-override").value = "";
        row.querySelector(".computed-share").textContent = "0" + getCurrencyFormat(currentCurrency).symbol;
      });
      allSelected = false;
      toggleAllBtn.textContent = "전체 선택";
      saveData();
    });
    
    /***********************************
     * 세부 내역서 (로그) 및 참가자 총액 재계산
    ***********************************/
    function updateExpenseLog() {
      expenseLogEl.innerHTML = "";
      expenseLog.slice().reverse().forEach(entry => {
        const div = document.createElement("div");
        div.className = "log-entry";
        div.innerHTML = `
          <header>[${entry.time}] - ${entry.reason} (총 ${formatTotal(entry.total)})</header>
          <div class="log-details">
            ${entry.distribution.map(d => `<span>${d.name}: ${formatIndividual(d.computed)}${d.manual > 0 ? " (+" + formatIndividual(d.manual) + ")" : ""}</span>`).join("")}
          </div>
          <div class="log-actions">
            <button class="edit-btn" data-id="${entry.id}">수정</button>
            <button class="delete-btn" data-id="${entry.id}">삭제</button>
          </div>
        `;
        div.querySelector(".delete-btn").addEventListener("click", function() {
          const id = parseInt(this.getAttribute("data-id"));
          if(confirm("정말로 이 정산 내역을 삭제하시겠습니까?")) {
            deleteExpense(id);
          }
        });
        div.querySelector(".edit-btn").addEventListener("click", function() {
          const id = parseInt(this.getAttribute("data-id"));
          openEditModal(id);
        });
        expenseLogEl.appendChild(div);
      });
    }
    function deleteExpense(expenseId) {
      const index = expenseLog.findIndex(entry => entry.id === expenseId);
      if(index !== -1) {
        expenseLog.splice(index, 1);
        recalcParticipantsTotals();
        updateExpenseLog();
        updateParticipantList();
        updateTotalDisplay();
        saveData();
      }
    }
    function recalcParticipantsTotals() {
      participants.forEach(p => p.total = 0);
      expenseLog.forEach(entry => {
        entry.distribution.forEach(d => {
          const p = participants.find(p => p.id === d.participantId);
          if(p) p.total += d.computed;
        });
      });
    }
    
    /***********************************
     * 정산서 복사 기능
    ***********************************/
    copyReportBtn.addEventListener("click", () => {
      let report = "";
      participants.forEach(p => {
        report += `[${p.name}] 총액: ${formatTotal(p.total)}\n`;
        expenseLog.forEach(entry => {
          const dist = entry.distribution.find(d => d.participantId === p.id);
          if(dist) {
            report += `${entry.time} - ${entry.reason} - ${formatIndividual(dist.computed)}\n`;
          }
        });
        report += "\n";
      });
      copyToClipboard(report);
      alert("정산서가 클립보드에 복사되었습니다.");
    });
    function copyToClipboard(text) {
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      document.body.removeChild(temp);
    }
    
    /***********************************
     * 데이터 내보내기 및 초기화 기능
    ***********************************/
    exportDataBtn.addEventListener("click", () => {
      const data = {
        participants,
        expenseLog,
        participantIdCounter,
        expenseIdCounter
      };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "expense_data.json";
      a.click();
      URL.revokeObjectURL(url);
    });
    resetDataBtn.addEventListener("click", () => {
      if(confirm("정말로 모든 데이터를 초기화하시겠습니까?")) {
        localStorage.clear();
        location.reload();
      }
    });
    
    /***********************************
     * 다크 모드 토글
    ***********************************/
    toggleDarkModeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      toggleDarkModeBtn.textContent = document.body.classList.contains("dark-mode") ? "라이트 모드" : "다크 모드";
    });
    
    /***********************************
     * 모달 내 분담액 자동 재계산 (총 금액 및 개별 override 지원)
    ***********************************/
    function recalcModalDistribution() {
      const total = parseFloat(editTotalInput.value) || 0;
      const shareInputs = Array.from(editDistributionEl.querySelectorAll("input"));
      let sumOverride = 0;
      let nonOverridden = [];
      shareInputs.forEach(input => {
        // 만약 해당 입력에 포커스 중이면 재계산 대상에서 제외
        if (document.activeElement === input) return;
        if (input.dataset.override === "true") {
          sumOverride += parseFloat(input.value) || 0;
        } else {
          nonOverridden.push(input);
        }
      });
      const remainder = total - sumOverride;
      if (nonOverridden.length > 0) {
        const equalShare = remainder / nonOverridden.length;
        nonOverridden.forEach(input => {
          input.value = Math.floor(equalShare);
        });
      }
    }
    
    function attachModalListeners() {
      const shareInputs = editDistributionEl.querySelectorAll("input");
      shareInputs.forEach(input => {
        input.addEventListener("input", () => {
          input.dataset.override = "true";
          recalcModalDistribution();
        });
        input.addEventListener("blur", () => {
          if(input.value === "") delete input.dataset.override;
          recalcModalDistribution();
        });
      });
    }
    
    /***********************************
     * 모달 (정산 내역 수정) 기능
     * 총 금액 수정 시 자동 분배(포커스 아웃 시) 및 override 지원
    ***********************************/
    function openEditModal(expenseId) {
      editingExpenseId = expenseId;
      const entry = expenseLog.find(e => e.id === expenseId);
      if (!entry) return;
      editReasonInput.value = entry.reason;
      editTotalInput.value = entry.total;
      editDistributionEl.innerHTML = "";
      entry.distribution.forEach(d => {
        const row = document.createElement("div");
        row.className = "edit-row";
        row.innerHTML = `<span>${d.name}</span>
                         <input type="number" value="${Math.floor(d.computed)}" min="0" data-participant="${d.participantId}" step="1">`;
        editDistributionEl.appendChild(row);
      });
      attachModalListeners();
      // 총 금액 수정 시 재계산 (on blur event)
      editTotalInput.addEventListener("blur", recalcModalDistribution);
      editExpenseModal.style.display = "flex";
    }
    function closeEditModal() {
      editingExpenseId = null;
      // 클리어 모달 내부 값 (선택 사항)
      editReasonInput.value = "";
      editTotalInput.value = "";
      editDistributionEl.innerHTML = "";
      editTotalInput.removeEventListener("blur", recalcModalDistribution);
      editExpenseModal.style.display = "none";
    }
    closeModalBtn.addEventListener("click", closeEditModal);
    cancelEditBtn.addEventListener("click", closeEditModal);
    saveEditBtn.addEventListener("click", () => {
      if(editingExpenseId === null) return;
      const entry = expenseLog.find(e => e.id === editingExpenseId);
      if (!entry) return;
      const newReason = editReasonInput.value.trim();
      const newTotal = parseFloat(editTotalInput.value);
      if (!newReason || isNaN(newTotal) || newTotal <= 0) {
        alert("올바른 사유와 총 금액을 입력하세요.");
        return;
      }
      const newDistribution = [];
      const editRows = editDistributionEl.querySelectorAll(".edit-row");
      editRows.forEach(row => {
        const input = row.querySelector("input");
        const participantId = parseInt(input.getAttribute("data-participant"));
        const computed = parseFloat(input.value) || 0;
        newDistribution.push({
          participantId: participantId,
          name: participants.find(p => p.id === participantId).name,
          manual: 0,
          computed: computed
        });
      });
      entry.reason = newReason;
      entry.total = newTotal;
      entry.distribution = newDistribution;
      recalcParticipantsTotals();
      updateExpenseLog();
      updateParticipantList();
      updateTotalDisplay();
      closeEditModal();
      saveData();
    });
    
    /***********************************
     * 참가자 추가 버튼 이벤트
    ***********************************/
    addParticipantBtn.addEventListener("click", () => {
      const name = participantNameInput.value.trim();
      if (!name) {
        alert("참가자 이름을 입력하세요.");
        return;
      }
      addParticipant(name);
    });
    
    /* 통화 선택 이벤트 */
    currencySelect.addEventListener("change", () => {
      currentCurrency = currencySelect.value;
      updateParticipantList();
      updateExpenseLog();
      updateExpenseParticipants();
    });
    
    function updateTotalDisplay() {
      const overall = participants.reduce((acc, cur) => acc + cur.total, 0);
      // 전체 총액 바로 업데이트
      // 예: "$123,456" 또는 "123,456₩"
      document.getElementById("expenseTotal").placeholder = `총 금액 (예: 38000)`;
    }
    
    // 초기 데이터 로드 및 UI 업데이트
    loadData();
    updateParticipantList();
    updateExpenseParticipants();
    updateExpenseLog();
    updateTotalDisplay();
  </script>
</body>
</html>
